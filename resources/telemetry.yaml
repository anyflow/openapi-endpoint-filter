apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: default # (Optional) Change if you want a non-default Telemetry resource
  namespace: istio-system # (Required) Update to your control plane namespace
spec:
  metrics:
    - providers:
        - name: prometheus # (Optional) Update to your metrics provider
      overrides:
        - match:
            metric: ALL_METRICS # (Optional) Refer to https://istio.io/latest/docs/reference/config/telemetry/#MetricSelector-IstioMetric
            mode: CLIENT_AND_SERVER # (Optional) Refer to https://istio.io/latest/docs/reference/config/telemetry/#WorkloadMode
          tagOverrides: # (Required) Map header values to metric labels
            request_host:
              value: request.host # (Optional) Request host label
            request_method:
              value: request.method # (Optional) HTTP method label
            request_endpoint:
              value: request.headers['x-api-endpoint'] # Header generated by openapi-endpoint-filter
            request_path_template:
              value: request.headers['x-path-template'] # Header generated by openapi-endpoint-filter
            request_service:
              value: request.headers['x-service-name'] # Header generated by openapi-endpoint-filter
